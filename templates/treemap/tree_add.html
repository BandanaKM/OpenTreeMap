{% extends "template_3.html" %}

{% block body_load %}class="contact"{% endblock %}

{% block tophead %}
	<script src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=6.2&mkt=en-us"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}openlayers/proj4js-compressed.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}openlayers/defs/EPSG102100.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}openlayers/defs/EPSG4326.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}openlayers/OpenLayers.js"></script>
    <script src="http://maps.googleapis.com/maps/api/js?key={{ API_KEY_GOOGLE_MAP }}&sensor=false"></script>
    <script type="text/javascript" src="treemap_settings.js"></script>
{% endblock %}

{% block body_id %}id="tree_add"{% endblock %}

{% block extrahead %}
    {% load compressed %}
    {% compressed_js 'map' %}
a
    <script type="text/javascript">
    jQuery().ready(function() {
        tm.init_add_map();
        jQuery("#calloutContainer").hide();

        jQuery("#addTree").submit(function(evt) {
        	tm.trackEvent("Add", "Add Tree");
        });
        jQuery("#id_edit_address_street").focus(function() {
        	if(jQuery("#id_edit_address_street")[0].value == "Enter an Address") {
        		jQuery("#id_edit_address_street")[0].value = "";
        	}
        });
        jQuery("#id_edit_address_city").focus(function() {
        	if(jQuery("#id_edit_address_city")[0].value == "Enter a City") {
        		jQuery("#id_edit_address_city")[0].value = "";
        	}
        });
        jQuery("#id_species_name").focus(function() {
        	if(jQuery("#id_species_name")[0].value == "Enter a Species Name") {
        		jQuery("#id_species_name")[0].value = "";
        	}
        });
        jQuery("#opt_field_group input").focus(function() {
        	if(this.value == "inches" || this.value == "feet") {
        		this.value = "";
        	}
        });

        if ('{{form.edit_address_street.value}}' != "") {
            jQuery("#update_map").click();
        }   
        jQuery("#id_dbh_type_0").attr('checked', 'checked');

        jQuery("#opt_field_toggle").click(function() {
            jQuery("#opt_field_group").toggle();
            tm.setupAutoComplete($('#id_species_name'));
        });
        jQuery("#id_dbh_type_0").attr('checked', 'checked');


    });
</script>
{% endblock %}


{% block left_panel %}
{% if messages %}
<!-- START TREEMAP/TREE_ADD.HTML -->
<div id="messages">
{% for message in messages %}
    <div {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</div>
    <div>You can add another tree below. <a href="{% url treemap.views.result_map %}">Done?</a></div>
{% endfor %}
</div>
{% endif %}

<div class="step-wrap">
	<div id="register" class="add">

		<h1>Add a New Tree <span class="note"></span></h1>

		{% if form.errors %}
		<div id="genError"><b>Oops!</b> There was a problem.<br />
			{% if form.non_field_errors %}
				<span id="smError">{{ form.non_field_errors }} </span></div>
			{% else %}
				<span id="smError">Error are noted in red below.</span></div>
			{% endif %}
		{% endif %}

		<form id="addTree" action="." method="POST">
		<fieldset>
		<div id="step1">
		<label id="step1-label" class="step-title" {% if form.edit_address_street.errors %}id="error"{% endif %}>Step 1 <span class="step-subtitle">Enter an address</span></label>
		{{ form.edit_address_street }}
		{{ form.edit_address_city }}
		<a href="javascript:void(0)" id="update_map" class="btn btn-inverse">Show on Map &raquo;</a>
    </div>
</div> <!-- end step 1 wrap -->

	<div class="step-wrap">
	<div id="mapHolder">
	    <div class="clearLeft" id="step2">
		    <label class="step-title">Step 2 <span class="step-subtitle">Specify Placement</span></label>
		    <div class="clearLeft"></div>
	    </div>

        <div id="mapHolderDirections">Click-and-drag the <span class="orange-highlight">orange circle</span> to move it to the correct location.</div>
        <div id="add_tree_map_wrap"><div id="add_tree_map" class="addMap"></div>
		    <div id="geocode_address"></div>
		    <div class="shadowLeft"></div>
		    <div class="shadowTop"></div>
	    </div>
	    <div id="add_tree_nearby">
		    <h1>Support</h1>
                    <p class="addbox">
						Running into a problem adding trees? <br/>
						<a href="{{ SITE_ROOT }}contact">Get in touch and we'll try to help &raquo;</a>
					</p>

		    <h1 class="title-edit" style="margin-top:20px;">Nearby Trees</h1>
		    <div id="nearby_trees"></div>
	    </div>
	</div> <!-- end step 2 wrapper -->

	<div class="clearLeft"> </div>
	<div class="step-wrap">
	    <div class="clearLeft" id="step3">
            <label class="step-title">Step 3 <span class="step-subtitle">Enter Optional Fields</span></label>
	        <!-- <span class="value"><a href="javascript:void(0);" id="opt_field_toggle">Enter Optional Fields</a></span> -->
            <div id="opt_field_group">
				<div id="leftCol">
					<!-- <span class="small"><a id="treekey" href="/treekey/" target="_blank">Not sure what kind of tree it is? Find out in the Tree Key</a></span> -->
					<label class="opt_fields">{{form.species_name.label}}</label>{{ form.species_name }}
					<!--<span class="small">Enter trunk size in inches -->
						{%for e in form.dbh.errors %}<span class="smError">{{e}}</span>{% endfor %}
					</span>
					<label class="opt_fields">{{form.dbh.label}} (inches)</label>{{ form.dbh }}

					<label class="opt_fields"> </label>
					<div id="dbh_type">{{ form.dbh_type }}</div>

					<!--<span class="small">Enter tree height in feet
						{%for e in form.height.errors %}<span class="smError">{{e}}</span>{% endfor %}
					</span>-->
					<label class="opt_fields">{{form.height.label}} (metres)</label>{{ form.height }}
					<!--<span class="small">Where is the tree planted?</span>-->
				</div>
				<div id="rightCol">
                                        <label class="opt_fields">Pest and diseases</label>
                                        {{ form.pests }}

					<label class="opt_fields">What is the tree's condition?</label>{{ form.condition }}

					<label class="opt_fields">{{form.status.label}}</label>{{ form.status }}
					<div class="clearLeft"></div>
				</div>
            </div>
            <div class="clearLeft"></div>
		</div>
	</div> <!-- end step 3 wrap -->
	
	<div class="step-wrap">
		
		<div class="clearLeft" id="step4">
			<label class="step-title">Step 4 <span class="step-subtitle">After I add this tree...</span></label>
			<div class="clearLeft" id="final-options">
			{{ form.target }} 
			</div>
			<div class="clearLeft"></div>
				<button type="submit" class="btn btn-inverse">Add this Tree!</button>
			</div>
		</div>
	</div> <!-- end step 4 wrap -->

	<!-- Hidden fields -->

    {{ form.species_id }}
    {{ form.lat }}
    {{ form.lon }}
    {{ form.edit_address_zip }}
    {{ form.geocode_address }}
    {{ form.initial_map_location }}


    </fieldset>
    </form>
    </div>
	<!-- END TREEMAP/TREE_ADD.HTML -->
    {% endblock %}

    {% block endpage %}

    <script type="text/javascript">
    if (navigator) {
        navigator.geolocation.getCurrentPosition(function(position) {
            tm.reverse_geocode({lat:position.coords.latitude, lon:position.coords.longitude}, function(ll, full_address, city, zip) {
                var short_address = full_address.split(city.split(' ')[0])[0].trim().replace(/,/g, '');
                $('#id_edit_address_street')[0].value = short_address;
                $('#id_edit_address_city')[0].value = city;
                $('#update_map').click();
            });
        });
    }
    </script>
    {% endblock endpage %}

