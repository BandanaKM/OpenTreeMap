jQuery(document).ready(function(){

  external_links_new_window = true;
	tweakHTML();
	markActiveMenuItem();
	addSocialTriggers();
  startRotators(); // not currently doing anything
  //debug();

});


/* =========================================================================================== */

	function tweakHTML(){
		// Preceed the author's name with "By " (forgive me)
		jQuery('.wp .post .entry-author a').prepend('By ');

		// Oh WP, why do you combine hard-coded content and variables in a single field?
		jQuery('.wp .comment-author').each(function(){
			author 		= jQuery(this).find('.fn');
			date   		= jQuery(this).find('> a');
			date   		= jQuery(date).text(jQuery(date).text().split(' ')[0]);
			date      = jQuery('<span class="entry-date"/>').append(date);
			separator = '<span class="entry-meta-sep" style=""> / </span>';
			jQuery(this).html('').append(author,separator,date);
		});
		
		// This was being autogenerated INSIDE the site! This caused z-index issues on scroll
		jQuery('body').append(jQuery('#wpadminbar'));

		// Open external links in a new window		
		if(external_links_new_window){
			setExternalLinks();
		}

	}

	function setExternalLinks(){	
		jQuery('a').each(function() {
			 var a = new RegExp('urbanforestproject.com');
			 if (!a.test(this.href)) {
				 jQuery(this)
				   .attr('rel','external')
					 .attr('target','_blank'); // Not that target attribute is deprecated at HTLM5 :(
			 }
		});
	}

	function addSocialTriggers(){

		// Setup Twitter button
		!function(d,s,id){
			var js,fjs=d.getElementsByTagName(s)[0];
			if(!d.getElementById(id)){
				js=d.createElement(s);
				js.id=id;
				js.src="//platform.twitter.com/widgets.js";
				fjs.parentNode.insertBefore(js,fjs);
			}
		}(document,"script","twitter-wjs");

		// Having to add URL of current page using JS as PHP won't grab the rewritten URL
		jQuery('.fb-like').attr('data-href',document.location.href).queue(function(){
			jQuery('body').prepend('<div id="fb-root"></div>');
			(function(d, s, id) {
				var js, fjs = d.getElementsByTagName(s)[0];
				if (d.getElementById(id)) return;
				js = d.createElement(s); js.id = id;
				js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
				fjs.parentNode.insertBefore(js, fjs);
			}(document, 'script', 'facebook-jssdk'));
		});

		// Add triggers to display correct social network tools
		jQuery('.wp .box-social li a').on("click",function(){
      // Having to resize these as they're initially given height/width of 0px because parent is hidden
      jQuery('.wp .box-social li.facebook .popper .fb-like > span, .wp .box-social li.facebook .popper .fb-like iframe').css({'width':'110px','height':'20px'});
			jQuery(this).parent().siblings('li').find('.popper:visible').fadeToggle();
			jQuery(this).siblings('.popper').fadeToggle();
			return false;
		});
	}

	function markActiveMenuItem(){
		if(jQuery('html.page_home').length > 0){
			return;
		}
		/* create regexp to match current url pathname and remove trailing slash if 
		  present as it could collide with the link in navigation in case trailing 
			slash wasn't present there. If deeper than root, will need to split path */
    var url = window.location.pathname, urlRegExp = new RegExp(url.replace(/\/$/,'') + "$");

		// now grab every link from the navigation
		jQuery('header #menu-wrapper a, .side-nav a').each(function(){
			// and test its normalized href against the url pathname regexp
			if(urlRegExp.test(this.href.replace(/\/$/,''))){
				// add class to all parent list items in current nav
				jQuery(this).parents('nav li').addClass('active');
			}
		});

		if(jQuery('.side-nav ul li:visible li').length == 0){ // if there is no visible sub nav in the side menu, hide the whole thing
			jQuery('.side-nav').hide();
		}

	}

  function startRotators(){

    // The main image can rotate, but I'm not sure it should. Maybe randomize on load?
    /*
    jQuery('.page_home #rotator').cycle({
      fx: 'fade',
      timeout: 5000,
      pause: 0, // Pause on hover = 1
      cleartype: true,
      cleartypeNoBg: true
    });
    */

		if(jQuery('.rotator').length > 0){
			jQuery('.rotator').prepend('<a class="rotatePrev rotateNav">&lt;</a><a class="rotateNext rotateNav">&gt;</a>');
				
			jQuery('.rotator .rotator-slides').cycle({
				fx: 'fade',
				timeout: 7000,
				pause: 0, // Pause on hover = 1
				cleartype: true,
				cleartypeNoBg: true,
				prev: '.rotatePrev',
				next: '.rotateNext'
			});
		} // more than 0

  }
    
  function isIE(){
    if (jQuery.browser.msie) {
      return parseInt(jQuery.browser.version, 10);
    }
    else{
      return false;
    }
  }



 function debug(){
   jQuery('.placeholder').attr('title','PLACEHOLDER');
 }




/* FUNCTIONS NOT USED AT THIS TIME
=========================================================================================== */

  function setupMCForm(){
    jQuery('#submitForm').on('click',function(event){
    //jQuery('#submitForm').click(function(event){
      event.preventDefault();
      console.log('foo');
      jQuery(this).parent('form').submit();
      console.log('bar');
    });
    if(isIE()){
      IEver = isIE();
      jQuery('html').addClass('IE'+IEver);
      if(IEver < 8){
        // Do extra stuff for IE7 and below
      }
      setDefaultValue();
    }
  }

  function setDefaultValue(){
    //console.log(jQuery('#mce-EMAIL').attr('placeholder'));
    //jQuery('#mce-EMAIL').val(jQuery(this).attr('placeholder')) // Doesn't work
    jQuery('#mce-EMAIL').val('Be the first to know when the project takes root.');
    jQuery('#mce-EMAIL').focus(function(){ // IE doesn't like chaining?
      if(jQuery(this).val() == jQuery(this).attr('placeholder')){
        jQuery(this).val('');
      }
    });
    jQuery('#mce-EMAIL').focusout(function(){
      if(jQuery(this).val() == ''){
        jQuery(this).val(jQuery(this).attr('placeholder'))
      }
    });
  }
  
